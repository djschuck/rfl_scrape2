name: Scrape Relay For Life Events

on:
  workflow_dispatch:
    inputs:
      run_au:
        description: "Run AU"
        type: boolean
        default: true
      run_uk:
        description: "Run UK"
        type: boolean
        default: true
      run_us:
        description: "Run US"
        type: boolean
        default: true
      run_ca:
        description: "Run CA"
        type: boolean
        default: true
      out_prefix:
        description: "Output file prefix (optional)"
        type: string
        default: "events"
  #schedule:
    # Daily at 03:23 UTC
    #- cron: "23 3 * * *"

jobs:
  scrape:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install
        run: |
          python -m pip install --upgrade pip
          pip install -e .

      - name: Install Playwright browsers
        run: |
          python -m playwright install chromium

      - name: Debug - show repo root
        run: |
          pwd
          ls -la
          echo "---- find seeds.yml ----"
          find . -maxdepth 3 -type f -name "seeds.yml" -print

      - name: Build country list
        id: countries
        shell: bash
        run: |
          COUNTRIES=""
          if [[ "${{ inputs.run_au }}" == "true" ]]; then COUNTRIES="${COUNTRIES},AU"; fi
          if [[ "${{ inputs.run_uk }}" == "true" ]]; then COUNTRIES="${COUNTRIES},UK"; fi
          if [[ "${{ inputs.run_us }}" == "true" ]]; then COUNTRIES="${COUNTRIES},US"; fi
          if [[ "${{ inputs.run_ca }}" == "true" ]]; then COUNTRIES="${COUNTRIES},CA"; fi

          # strip leading comma
          COUNTRIES="${COUNTRIES#,}"

          if [[ -z "$COUNTRIES" ]]; then
            echo "No countries selected. Exiting."
            exit 1
          fi

          echo "countries=$COUNTRIES" >> "$GITHUB_OUTPUT"
          echo "Selected: $COUNTRIES"

      - name: Run scraper
        env:
          PYTHONUNBUFFERED: "1"
        run: |
          mkdir -p out
          relay-scrape \
            --config seeds.yml \
            --countries "${{ steps.countries.outputs.countries }}" \
            --out "out/${{ inputs.out_prefix }}.csv" \
            --json "out/${{ inputs.out_prefix }}.json" \
            --log "out/scrape.log"
            
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: relay-events
          path: out/
          if-no-files-found: error
          retention-days: 120
